<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fancy Todo</title>
</head>
<body>
    <button id="logout-btn">Logout</button>
    <nav>
        <p>Fancy Todo</p>
    </nav>
    <div id="login-page">
        <h1>Login</h1>
        <form>
            <label>email</label><br>
            <input type="text" placeholder="email" id="email"><br><br>
            <label>password</label><br>
            <input type="password" placeholder="password" id="password"><br><br>
            <button id="submit-login">Login</button>
        </form>
    </div>
    <div class="list-todo"><br><br>
        <table class="todo-container">
            <tr>
                <th>No</th>
                <th>Todo</th>
                <th>Description</th>
                <th>Due Date</th>
                <th>Location</th>
                <th>Status</th>
                <th>actions</th>
            </tr>
            <tr>
                <td></td>
            </tr>
        </table>
    </div>
    <div id="create-page">

    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        const baseServer = 'http://localhost:3000'

        function fetchDelet (id) {
            $.ajax(`${baseServer}/todos/${id}`, {
                method: `DELETE`,
                headers: {
                    access_token : localStorage.getItem('access_token')
                }
            })
            .done(result => {
                fetchTodo()
            })
            .fail(err => {
                console.log(err)
            })
        }

        function getDate (date) {
            let editDate = new Date (date)
            return new Intl.DateTimeFormat('en-GB').format(editDate)
        }

        function fetchTodo() {
            $.ajax(`${baseServer}/todos`, {
                method: `GET`,
                headers: {
                    access_token : localStorage.getItem('access_token')
                }
            })
            .done(result => {
                $('.todo-container').empty()
                result.todos.forEach(todo => {
                    $('.todo-container').append(`<tr>
                        <td>${todo.id}</td>
                        <td>${todo.title}</td>
                        <td>${todo.description}</td>
                        <td>${getDate(todo.due_date)}</td>
                        <td>${todo.location}</td>
                        <td>${todo.status}</td>
                        <td>
                            <button id="edit-todo"> edit </button>
                            <button id="delete-todo" onclick="fetchDelet(${todo.id})"> delete </button>
                        </td>
                        </tr>`
                    )
                })
            })
            .fail(err => {
                console.log(err)
            })
        }


        $(document).ready(function () {
            if (localStorage.getItem('access_token')){
                fetchTodo()
                $('#login-page').hide()
                $('.todo-container').show()

            }
            else{
                $('#login-page').show()
                $('.todo-container').hide()
            }

            $('#login-page').on('submit', function (event) {
                event.preventDefault()
                const email = $('#email').val()
                const password = $('#password').val()
                $('login-page').trigger('reset')
                $.ajax(`${baseServer}/login`, {
                    method: `POST`,
                    data: {
                        email,
                        password
                    }
                })
                .done((result) => {
                    console.log(result)
                    localStorage.setItem('access_token', result.accessToken)
                    $('.todo-container').show()
                    $('#login-page').hide()
                    fetchTodo()
                })
                .fail((err) => {
                    console.log(err)
                })
                .always(()=>{
                    $('#login-page').trigger('reset')
                })
            })

            $('#logout-btn').on('click', () => {
                $('#login-page').show()
                $('.todo-container').hide()
                localStorage.clear()
            })

        })
    </script>
</body>
</html>