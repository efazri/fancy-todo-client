<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fancy Todo</title>
</head>
<body>
    <nav>
        <p id="fancy_todo">Fancy Todo</p>
        <button id="create-todo">Create New Todo</button>
    </nav>
    <div id="login-page">
        <h1>Login</h1>
        <form>
            <label>email</label><br>
            <input type="text" placeholder="email" id="email"><br><br>
            <label>password</label><br>
            <input type="password" placeholder="password" id="password"><br><br>
            <button id="submit-login">Login</button>
        </form>
    </div>

    <div class="main page"><br><br>
        <button id="logout-btn">Logout</button>
        <h1 id="header-todo-list">Your Todo list</h1>
        <table class="todo-container">
        </table>
    </div>

    <div id="create-page">
        <form>
            <label for="title">Title</label><br>
            <input type="text" id="title"><br><br>
            <label for="description">Description</label><br>
            <textarea id="description" cols="20" rows="10"></textarea><br><br>
            <label>Status</label><br>
            <select id="status">
                <option value="uncompleted">uncompleted</option>
                <option value="completed">compeleted</option>
            </select><br><br>
            <label for="due_date">Due Date</label><br>
            <input type="date" id="due_date"><br><br>
            <label for="location">Location</label><br>
            <input type="text" id="location"><br><br>
            <button id="submit_todo">Create</button>
        </form>
    </div>

    <div id="edit-page">
        <form>
            <label for="title">Title</label><br>
            <input type="text" id="edit-title"><br><br>
            <label for="edit-description">Description</label><br>
            <input type="text" id="edit-description" cols="20" rows="10"></input><br><br>
            <label>Status</label><br>
            <select id="edit-status">
                <option value="uncompleted">uncompleted</option>
                <option value="completed">compeleted</option>
            </select><br><br>
            <label for="due_date">Due Date</label><br>
            <input type="date" id="edit-due_date"><br><br>
            <label for="location">Location</label><br>
            <input type="text" id="edit-location"><br><br>
            <button id="edit-submit">Create</button>
        </form>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        const baseServer = 'http://localhost:3000'

        function formatDate(date) {
            var d = new Date(date),
            month = '' + (d.getMonth() + 1),
            day = '' + d.getDate(),
            year = d.getFullYear();

            if (month.length < 2) 
                month = '0' + month;
            if (day.length < 2) 
                day = '0' + day;

            return [year, month, day].join('-');
        }

        function fetchDelete (id) {
            $.ajax(`${baseServer}/todos/${id}`, {
                method: `DELETE`,
                headers: {
                    access_token : localStorage.getItem('access_token')
                }
            })
            .done(result => {
                fetchTodo()
            })
            .fail(err => {
                console.log(err)
            })
        }

        function editTodo (id) {
            $('.todo-container').hide()
            $('#logout-btn').hide()
            $('#create-todo').hide()
            $('#todo-header').hide()
            $('#header-todo-list').hide()
            $('#login-page').hide()
            $('#create-page').hide()
            $('#edit-page').show()

            $.ajax(`${baseServer}/todos/${id}`, {
                method : 'GET',
                headers : {
                    access_token : localStorage.getItem('access_token')
                }
            })
            .done(result => {
                console.log(result)
                $("#edit-title").val(result.todo.title)
                $("#edit-description").val(result.todo.description)
                $("#edit-due_date").val(formatDate(result.todo.due_date))
                $("#edit-location").val(result.todo.location)
                result.todo.status === $("#edit-status").val() ? "selected" : ""
            })
            .fail(err => {
                throw err
            })

        }

        function getDate (date) {
            let editDate = new Date (date)
            return new Intl.DateTimeFormat('en-GB').format(editDate)
        }

        function fetchTodo() {
            $.ajax(`${baseServer}/todos`, {
                method: `GET`,
                headers: {
                    access_token : localStorage.getItem('access_token')
                }
            })
            .done(result => {
                $('.todo-container').empty()
                $('.todo-container').append(`<tr>
                <th>No</th>
                <th>Todo</th>
                <th>Description</th>
                <th>Due Date</th>
                <th>Location</th>
                <th>Status</th>
                <th>Actions</th>
                </tr>`)
                result.todos.forEach(todo => {
                    $('.todo-container').append(`<tr>
                        <td>${todo.id}</td>
                        <td>${todo.title}</td>
                        <td>${todo.description}</td>
                        <td>${getDate(todo.due_date)}</td>
                        <td>${todo.location}</td>
                        <td>${todo.status}</td>
                        <td>
                            <button id="edit-todo" onclick="editTodo(${todo.id})"> edit </button>
                            <button id="delete-todo" onclick="fetchDelete(${todo.id})"> delete </button>
                        </td>
                        </tr>`
                    )
                })
            })
            .fail(err => {
                console.log(err)
            })
        }

        $(document).ready(function () {
            if (localStorage.getItem('access_token')){
                fetchTodo()
                $('.todo-container').show()
                $('#logout-btn').show()
                $('#create-todo').show()
                $('#todo-header').show()
                $('#header-todo-list').show()
                $('#login-page').hide()
                $('#create-page').hide()
                $('#edit-page').hide()

            }
            else{
                $('#login-page').show()
                $('#create-todo').hide()
                $('.todo-container').hide()
                $('#logout-btn').hide()
                $('#create-page').hide()
                $('#header-todo-list').hide()
                $('#todo-header').hide()
                $('#edit-page').hide()

            }

            $('#login-page').on('submit', (event) => {
                event.preventDefault()
                const email = $('#email').val()
                const password = $('#password').val()
                $('#login-page').trigger('reset')
                $.ajax(`${baseServer}/login`, {
                    method: `POST`,
                    data: {
                        email,
                        password
                    }
                })
                .done((result) => {
                    localStorage.setItem('access_token', result.accessToken)
                    $('.todo-container').show()
                    $('#create-todo').show()
                    $('#logout-btn').show()
                    $('#header-todo-list').show()
                    $('#login-page').hide()
                    $('#create-page').hide()
                    $('#edit-page').hide()

                    fetchTodo()
                })
                .fail((err) => {
                    console.log(err)
                })
                .always(()=>{
                    $('#login-page').trigger('reset')
                })
            })

            $('#logout-btn').on('click', () => {
                $('#login-page').show()
                $('.todo-container').hide()
                $('#logout-btn').hide()
                $('#create-page').hide()
                $('#create-todo').hide()
                $('#header-todo-list').hide()
                $('#edit-page').hide()
                localStorage.clear()
            })

            $('#create-todo').on('click', () => {
                $('#create-page').show()
                $('#create-todo').hide()
                $('#login-page').hide()
                $('.todo-container').hide()
                $('#logout-btn').hide()
                $('#header-todo-list').hide()
                $('#edit-page').hide()

            })

            $('#submit_todo').on('click', (event) => {
                    event.preventDefault
                    $('#create-page').trigger('reset')
                    $.ajax(`${baseServer}/todos?lat=6.32275&lng=107.3376`, {
                        method : 'POST',
                        headers : {
                            access_token : localStorage.getItem('access_token')
                        },
                        data : {
                            title: $('#title').val(),
                            description: $('#description').val(),
                            status: $('#status').val(),
                            due_date: $('#due_date').val(),
                            location: $('#location').val()
                        }
                    })
                    .done(result => {
                        fetchTodo()
                    })
                    .fail(err => {
                        console.log(err)
                    })
            })
            
        })
    </script>
</body>
</html>